<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>最蠢的实现方法</title>
</head>
<body>
  <div id="app" class="section">
    <div>
      <label>定时器：</label>
      <input type="text" value="{{count}}">
      <button class="cancel-btn">{{text}}</button>
    </div>
    <div>
      <label>此时的数值是</label>
      <span>{{count}}</span>
    </div>
  </div>
  <script>
    /*
    ** bug一堆，性能无比糟糕，一步一步来，慢慢改善！！！
    */

    const objUtil = function() {
      return {
        get(obj = {}, path) {
          if (!obj || !path) {
            return null;
          }
          const array = path.split('.');
          for (let i = 0, len = array.length; i < len; i++) {
            obj = obj[array[i]];
            if (obj === null || typeof obj === 'undefined') {
              return null;
            }
          }
          return obj;
        },
        set(obj = {}, path, value) {
          if (!obj || !path) {
            return null;
          }
          const array = path.split('.');
          for (let i = 0, len = array.length; i < len; i++) {
            if (i < len - 1) {
              obj = (obj[array[i]] = obj[array[i]] || {});
            } else {
              obj[array[i]] = value;
            }
          }
        },
        remove(obj = {}, path) {
          if (!obj || !path) {
            return null;
          }
          const array = path.split('.');
          for (let i = 0, len = array.length; i < len; i++) {
            if (i < len - 1) {
              obj = (obj[array[i]] = obj[array[i]] || {});
            } else {
              delete obj[array[i]];
            }
          }
        }
      }
    }

    class MVVM {
      constructor (opt) {
        this.dom = document.querySelector(opt.el)
        this.data = opt.data || {}
        this.makeReactive(this.data)
        this.renderDom(this.dom)
      }

      renderAttr (node) {
        const attrs = node.attributes
        for (let attr of attrs) {
          if (!attr.copyNodeValue) attr.copyNodeValue = attr.nodeValue
          let nodeValue = attr.copyNodeValue
          if (attr.name !== 'value') {
            if (nodeValue !== undefined || nodeValue !== null) {
              attr.nodeValue = nodeValue.trim().replace(/{{\s*([^\s]*)\s*}}/, (match, $1) => {
                return objUtil().get(this.data, $1) || match
              })
            }
          } else {
            node.value = nodeValue.trim().replace(/{{\s*([^\s]*)\s*}}/, (match, $1) => {
              node.addEventListener('input', e => {
                objUtil().set(this.data, $1, e.target.value)
              })
              return objUtil().get(this.data, $1) || match
            })
          }
        }
      }

      renderContext (node) {
        if (!node.copyNodeValue) node.copyNodeValue = node.nodeValue
        let nodeValue = node.copyNodeValue
        if (nodeValue !== undefined || nodeValue !== null) {
          node.nodeValue = nodeValue.replace(/{{\s*([^\s^}]*)\s*}}/g, (match, $1) => {
            return objUtil().get(this.data, $1) || match
          })
        }
      }

      renderDom (dom) {
        this.renderAttr(dom)
        const children = dom.childNodes
        for (let child of children) {
          if (child.nodeType === 1) {
            this.renderDom(child)
          } else if (child.nodeType === 3) {
            this.renderContext(child)
          }
        }
      }

      makeReactive (obj) {
        const self = this
        Object.keys(obj).forEach(key => {
          let value = obj[key]
          if (typeof value === 'object' && value !== null) {
            this.makeReactive(value)
          } else {
            Object.defineProperty(obj, key, {
              enumerable: true,
              configurable: false,
              get: function () {
                return value
              },
              set: function (newVal) {
                value = newVal
                self.renderDom(self.dom)
              }
            })
          }
        })
      }
    }


    const app = new MVVM({
      el: '#app',
      data: {
        count: 1,
        text: '开始'
      }
    })

    const cancelBtn = app.dom.querySelector('.cancel-btn')
    cancelBtn.addEventListener('click', () => {
      app.data.text = app.data.text === '开始' ? '取消' : '开始'
      if (app.data.text === '取消') {
        app.timer = setInterval(() => {
          app.data.count++
        }, 1000)
      } else {
        clearInterval(app.timer)
      }
    })

  </script>
</body>
</html>